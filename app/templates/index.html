<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Code Agent</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --chat-bg: #252526;
            --user-msg-bg: #0e639c;
            --ai-msg-bg: #3c3c3c;
            --text-color: #d4d4d4;
            --input-bg: #3c3c3c;
            --border-color: #454545;
            --icon-color: #cccccc;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        /* Header */
        #header {
            padding: 10px 20px;
            background-color: var(--chat-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--icon-color);
            padding: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .icon-btn svg {
            stroke: currentColor;
        }

        /* Chat Area */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .message-row {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }
        .message-row.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-row.ai {
            align-self: flex-start;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--chat-bg);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .avatar svg {
            width: 20px;
            height: 20px;
            stroke: var(--icon-color);
        }
        .message-bubble {
            padding: 10px 15px;
            border-radius: 8px;
            line-height: 1.5;
            position: relative;
            min-width: 0; /* Fix flex overflow */
            word-wrap: break-word;
        }
        .user .message-bubble {
            background-color: var(--user-msg-bg);
            color: white;
        }
        .ai .message-bubble {
            background-color: var(--ai-msg-bg);
            color: var(--text-color);
        }
        .error-message {
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        /* Tools */
        .tool-usage {
            font-size: 0.9em;
            color: #aaa;
            margin-left: 44px; /* Align with text start (32 avatar + 12 gap) */
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .tool-usage svg {
            width: 16px;
            height: 16px;
            stroke: #007acc;
        }

        /* Input Area */
        #input-area {
            padding: 20px;
            background-color: var(--chat-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            outline: none;
        }
        button.primary-btn {
            padding: 10px 20px;
            background-color: var(--user-msg-bg);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button.primary-btn:hover {
            opacity: 0.9;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        pre {
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        code {
            font-family: 'Consolas', 'Monaco', monospace;
        }
        /* Deploy Button in Chat */
        .deploy-btn {
            background-color: #2da44e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }
        .deploy-btn:hover {
            background-color: #2c974b;
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="header-title">
            <!-- Bot Icon Inline -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            <span>Gemini Agent</span>
        </div>
        <div class="header-controls">
            <span style="font-size: 0.9em; color: #aaa;">
                ðŸ“‚ <span id="repo-status">Loading...</span>
            </span>
            <button onclick="gitPull()" class="icon-btn" title="Git Pull">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
            <button onclick="clearHistory()" class="icon-btn" title="Clear History">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        </div>
    </div>

    <div id="chat-container"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Ask about your code..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="primary-btn" onclick="sendMessage()">Send</button>
    </div>

    <script>
        // Icons
        const ICONS = {
            bot: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`,
            user: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            tool: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>`
        };

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');

        let currentOffset = 0;
        const limit = 20;
        let isLoadingHistory = false;
        let hasMoreHistory = true;

        async function loadHistory(isScrollUp = false) {
            if (isLoadingHistory || (!hasMoreHistory && isScrollUp)) return;
            isLoadingHistory = true;

            const oldHeight = chatContainer.scrollHeight;

            try {
                const res = await fetch(`/api/history?limit=${limit}&offset=${currentOffset}`);
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    const fragment = document.createDocumentFragment();

                    data.messages.forEach(msg => {
                        const parts = msg.parts || [{text: ""}];
                        const text = parts[0].text || "";
                        const div = createMessageElement(msg.role, text);
                        fragment.appendChild(div);
                    });

                    if (isScrollUp) {
                        chatContainer.insertBefore(fragment, chatContainer.firstChild);
                        const newHeight = chatContainer.scrollHeight;
                        chatContainer.scrollTop = newHeight - oldHeight;
                    } else {
                        chatContainer.appendChild(fragment);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    currentOffset += data.messages.length;
                    hasMoreHistory = data.has_more;
                } else {
                    hasMoreHistory = false;
                }

                // Check for active task on initial load
                if (!isScrollUp && !hasMoreHistory) {
                    // We only check if we are at the bottom (or it's the first load which is effectively bottom if history is short)
                    // Actually, logic: if it is initial load (!isScrollUp), we should check.
                    const statusRes = await fetch('/chat/status');
                    const statusData = await statusRes.json();

                    if (statusData.active) {
                        const aiRow = createMessageElement('model', '');
                        chatContainer.appendChild(aiRow);
                        const aiBubble = aiRow.querySelector('.message-bubble');
                        streamEvents('/chat/stream_active', aiBubble);
                    }
                }

            } catch (e) {
                console.error("Failed to load history:", e);
            } finally {
                isLoadingHistory = false;
            }
        }

        function streamEvents(url, targetBubble) {
            const source = new EventSource(url);
            let currentAiText = targetBubble.dataset.raw || "";

            // Remove any existing status indicator
            removeStatusIndicator();
            scrollToBottom();

            source.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    currentAiText += data;
                    targetBubble.dataset.raw = currentAiText;
                    targetBubble.innerHTML = marked.parse(currentAiText);

                    // Check for Jules Prompt marker
                    if (currentAiText.includes("## Jules Prompt")) {
                        addDeployButton(targetBubble);
                    }

                    // We received text, so probably tool is done if it was running (or concurrent)
                    removeStatusIndicator();
                    scrollToBottom();

                } catch (e) {
                    console.error("Error parsing message JSON:", e);
                }
            };

            source.addEventListener("tool", function(event) {
                 let toolText = "Executing tools...";
                 try {
                     toolText = JSON.parse(event.data);
                 } catch(e) {
                     toolText = event.data || toolText;
                 }
                 showStatusIndicator(toolText);
            });

            source.addEventListener("error", function(event) {
                console.error("EventSource error:", event);
                source.close();
                removeStatusIndicator();
            });

            source.addEventListener("done", function(event) {
                source.close();
                removeStatusIndicator();
            });
        }

        function createMessageElement(role, text) {
            const row = document.createElement('div');
            const isAi = (role === 'model' || role === 'ai');
            row.className = `message-row ${isAi ? 'ai' : 'user'}`;

            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = isAi ? ICONS.bot : ICONS.user;
            row.appendChild(avatar);

            // Bubble
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.dataset.raw = text || "";
            bubble.innerHTML = marked.parse(text || "");

            if (isAi && text && text.includes("## Jules Prompt")) {
                addDeployButton(bubble);
            }

            row.appendChild(bubble);
            return row;
        }

        function addDeployButton(messageBubble) {
             if (messageBubble.querySelector('button.deploy-btn')) return;
             const deployBtn = document.createElement('button');
             deployBtn.className = 'deploy-btn';
             deployBtn.innerHTML = "ðŸš€ Start Jules Task";
             deployBtn.onclick = function() { deploy(this); };
             messageBubble.appendChild(deployBtn);
        }

        function sendRequest(text) {
            const streamUrl = '/chat?message=' + encodeURIComponent(text);

            // Create AI Bubble
            const aiRow = createMessageElement('model', '');
            chatContainer.appendChild(aiRow);
            const aiBubble = aiRow.querySelector('.message-bubble');

            streamEvents(streamUrl, aiBubble);
        }

        function showStatusIndicator(text) {
            removeStatusIndicator();
            const div = document.createElement('div');
            div.id = 'temp-status-indicator';
            div.className = 'tool-usage';
            div.innerHTML = ICONS.tool + ' ' + text;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function removeStatusIndicator() {
            const el = document.getElementById('temp-status-indicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
             chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            const userRow = createMessageElement('user', text);
            chatContainer.appendChild(userRow);
            scrollToBottom();
            userInput.value = '';

            currentOffset++;

            sendRequest(text);
        }

        async function deploy(btn) {
            const messageBubble = btn.parentElement;
            let rawText = messageBubble.dataset.raw || "";
            let promptText = rawText;

            const marker = "## Jules Prompt";
            const markerIndex = rawText.indexOf(marker);
            if (markerIndex !== -1) {
                promptText = rawText.substring(markerIndex);
            }

            btn.innerText = "â³ Sending...";
            btn.disabled = true;

            try {
                const response = await fetch('/api/deploy_to_jules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText })
                });

                const data = await response.json();

                if (data.success) {
                    const sessionName = data.result.name || "Unknown Session";
                    btn.innerText = `âœ… Started! (${sessionName})`;
                    btn.onclick = null;
                } else {
                    btn.innerText = "âŒ Error";
                    alert("Error deploying: " + data.error);
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                btn.innerText = "âŒ Error";
                alert("Error deploying: " + e.message);
                btn.disabled = false;
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                document.getElementById('repo-status').innerText = `${data.project} (${data.branch})`;
            } catch(e) {
                console.error(e);
                document.getElementById('repo-status').innerText = "Error";
            }
        }

        async function gitPull() {
             const btn = document.querySelector('button[title="Git Pull"]');
             if(!btn) return;
             btn.disabled = true;

             try {
                const res = await fetch('/api/git_pull', {method: 'POST'});
                const data = await res.json();
                alert(data.output);
             } catch(e) {
                alert("Error: " + e.message);
             } finally {
                btn.disabled = false;
                updateStatus();
             }
        }

        async function clearHistory() {
            if (!confirm("Are you sure you want to clear the chat history?")) return;

            try {
                const res = await fetch('/api/reset', { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') {
                    chatContainer.innerHTML = '';
                    currentOffset = 0;
                    window.location.reload();
                } else {
                    alert("Failed to clear history: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                console.error(e);
                alert("Error clearing history.");
            }
        }

        chatContainer.addEventListener('scroll', () => {
             if (chatContainer.scrollTop === 0) {
                 loadHistory(true);
             }
        });

        // Call on load
        updateStatus();
        loadHistory(false);
    </script>
</body>
</html>
